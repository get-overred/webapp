(function(){"use strict";function N(t){if(t.startsWith("rgba"))return x(t);const o=t.replace("#","");return{r:parseInt(o.substring(0,2),16),g:parseInt(o.substring(2,4),16),b:parseInt(o.substring(4,6),16)}}function x(t){const o=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);return o?{r:parseInt(o[1]),g:parseInt(o[2]),b:parseInt(o[3])}:(console.warn("Invalid rgba color format:",t),{r:0,g:0,b:0})}let b={canvas:null,options:{_overlay_x:0,_overlay_y:0,_overlay_width:0,_overlay_height:0,target_bg_rgb:{r:0,g:0,b:0}},target_bg_color:"rgba(0, 0, 0, 1)"};self.onmessage=async t=>{console.log("Worker called"),console.log("Worker received data:",t.data);const{backdropBitmap:o,cursorBitmap:a,targetData:r,options:s}=t.data,{target_bg_color:i,target_border_radius:e,target_no_fillout:l,target_replace_cursor:u,target_enable_arrow:d,image_border_radius:_,target_scale_factor:y,_overlay_x:k,_overlay_y:w,_overlay_width:m,_overlay_height:p,_strokeWidth:h,border:c}=s,n=new OffscreenCanvas(r.canvas_width,r.canvas_height),g=n.getContext("2d");if(g){b.canvas=n,b.options={_overlay_x:k,_overlay_y:w,_overlay_width:m,_overlay_height:p,target_bg_rgb:N(i)},b.target_bg_color=i;try{console.log("Processing images..."),console.log("Backdrop dimensions:",o.width,"x",o.height);const f=N(i);g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",g.clearRect(0,0,n.width,n.height),g.fillStyle="rgba(0, 0, 0, 0)",g.fillRect(0,0,n.width,n.height),I(Number(_));let C=y;C==="0.99"&&(C=Math.min(n.width/(n.width/4+m),n.width/(n.width/4+m)).toString());const $=Number(C),{width:F,height:E}=n;let v={x:k*$-(F-m*$)/2,y:w*$-(E-p*$)/2};if(v.x<0&&(v.x=0),v.y<0&&(v.y=0),v.x>n.width*$-n.width&&(v.x=n.width*$-n.width),v.y>n.height*$-n.height&&(v.y=n.height*$-n.height),g.setTransform($,0,0,$,-v.x,-v.y),g.drawImage(o,0,0,n.width,n.height),u)g.drawImage(a,r.click_x,r.click_y,75,75);else{const P=i.startsWith("rgba")?parseFloat(i.match(/[\d.]+\)$/)?.[0]??"1.0"):1;g.strokeStyle=`rgba(${f.r}, ${f.g}, ${f.b}, ${P})`,g.lineWidth=l?h*2.5:h,g.beginPath(),g.roundRect(k-h*2,w-h*2,m+h*4,p+h*4,[Number(e),Number(e),Number(e),Number(e)]),g.stroke(),l||(g.beginPath(),g.roundRect(k,w,m,p,[Number(e),Number(e),Number(e),Number(e)]),g.strokeStyle=`rgba(${f.r}, ${f.g}, ${f.b}, ${P*.333})`,g.lineWidth=h,g.stroke(),g.fillStyle=`rgba(${f.r}, ${f.g}, ${f.b}, ${P*.666})`,g.fill())}d&&z();const O=await n.convertToBlob(),{width:A}=R(c),W=A*(c.includes("double")?3:1),S=new OffscreenCanvas(n.width+W*2,n.height+W*2),B=S.getContext("2d");if(!B)return;L(B,c,S.width,S.height,Number(_)),B.drawImage(n,W,W);const J=await S.convertToBlob();self.postMessage({blob:O,blobWithBorder:J})}catch(f){console.error("Error in worker:",f)}}};function I(t){const o=b.canvas.getContext("2d");if(!o)return;const a=b.canvas.width,r=b.canvas.height;o.beginPath(),o.moveTo(t,0),o.arcTo(a,0,a,r,t),o.arcTo(a,r,0,r,t),o.arcTo(0,r,0,0,t),o.arcTo(0,0,a,0,t),o.closePath(),o.clip()}function z(){if(!b.canvas.getContext("2d"))return;const{_overlay_x:o,_overlay_y:a,_overlay_width:r,_overlay_height:s,target_bg_rgb:i}=b.options,e=b.canvas,l=b.target_bg_color.startsWith("rgba")?parseFloat(b.target_bg_color.match(/[\d.]+\)$/)?.[0]??"1.0"):1,u=o*a,d=o*(e.height-(a+s)),_=(e.width-(o+r))*a,y=(e.width-(o+r))*(e.height-(a+s)),k=Math.max(u,d,_,y),w=10,m=50-w,p=50-w,h=120;let c,n;switch(k){case u:c=[o-m,a-p],n=[c[0]-h,c[1]-h],M(c,n,l),T(c,n,"tl",l);break;case d:c=[o-m,a+s+p],n=[c[0]-h,c[1]+h],M(c,n,l),T(c,n,"bl",l);break;case _:c=[o+r+m,a-p],n=[c[0]+h,c[1]-h],M(c,n,l),T(c,n,"tr",l);break;case y:c=[o+r+m,a+s+p],n=[c[0]+h,c[1]+h],M(c,n,l),T(c,n,"br",l);break}}function M(t,o,a){const r=b.canvas.getContext("2d");if(!r)return;const{target_bg_rgb:s}=b.options;r.strokeStyle=`rgba(${s.r}, ${s.g}, ${s.b}, ${a})`,r.lineWidth=10,r.beginPath(),r.moveTo(t[0],t[1]),r.lineTo(o[0],o[1]),r.stroke()}function T(t,o,a,r){const s=b.canvas.getContext("2d");if(!s)return;const{target_bg_rgb:i}=b.options,e=o[0]-t[0],l=o[1]-t[1],u=t[0]+.1*e,d=t[1]+.1*l;s.fillStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${r})`,s.beginPath(),a.includes("t")&&(s.moveTo(u+10,a==="tl"?d-10:d+10),s.lineTo(u-10,a==="tl"?d+10:d-10),s.lineTo(a==="tl"?t[0]+10:t[0]-10,t[1]+10)),a.includes("b")&&(s.moveTo(u+10,a==="bl"?d+10:d-10),s.lineTo(u-10,a==="bl"?d-10:d+10),s.lineTo(a==="bl"?t[0]+10:t[0]-10,t[1]-10)),s.fill()}function R(t){const o=t.trim().split(/\s+/);let a="solid",r=1,s="rgb(0, 0, 0)";for(const i of o)["solid","double","dashed","dotted","ridge","groove","inset","outset"].includes(i)?a=i:i.endsWith("px")?r=parseInt(i):(i.startsWith("rgb")||i.startsWith("#"))&&(s=i);return{style:a,width:r,color:s}}function D(t,o){const a=t.match(/\d+/g)?.map(Number)||[0,0,0],[r,s,i]=a;switch(o){case"ridge":return{outer:`rgb(${Math.min(r+40,255)}, ${Math.min(s+40,255)}, ${Math.min(i+40,255)})`,inner:`rgb(${Math.max(r-40,0)}, ${Math.max(s-40,0)}, ${Math.max(i-40,0)})`};case"groove":return{outer:`rgb(${Math.max(r-40,0)}, ${Math.max(s-40,0)}, ${Math.max(i-40,0)})`,inner:`rgb(${Math.min(r+40,255)}, ${Math.min(s+40,255)}, ${Math.min(i+40,255)})`};case"inset":return{outer:`rgb(${Math.max(r-40,0)}, ${Math.max(s-40,0)}, ${Math.max(i-40,0)})`,inner:`rgb(${Math.min(r+40,255)}, ${Math.min(s+40,255)}, ${Math.min(i+40,255)})`};case"outset":return{outer:`rgb(${Math.min(r+40,255)}, ${Math.min(s+40,255)}, ${Math.min(i+40,255)})`,inner:`rgb(${Math.max(r-40,0)}, ${Math.max(s-40,0)}, ${Math.max(i-40,0)})`};default:return{outer:t,inner:t}}}function L(t,o,a,r,s){const{style:i,width:e,color:l}=R(o),{outer:u,inner:d}=D(l,i),_=s+e;switch(t.lineWidth=e,t.lineJoin="round",t.lineCap="round",i){case"double":{const y=e;t.strokeStyle=l,t.beginPath(),t.roundRect(e/2,e/2,a-e,r-e,_),t.stroke(),t.beginPath(),t.roundRect(e+y,e+y,a-2*(e+y),r-2*(e+y),Math.max(0,s-y)),t.stroke();break}case"ridge":case"groove":case"inset":case"outset":{t.strokeStyle=u,t.beginPath(),t.roundRect(e/2,e/2,a-e,r-e,_),t.stroke(),t.strokeStyle=d,t.beginPath(),t.roundRect(e,e,a-2*e,r-2*e,s),t.stroke();break}case"dashed":{t.strokeStyle=l,t.setLineDash([e*2,e]),t.beginPath(),t.roundRect(e/2,e/2,a-e,r-e,_),t.stroke(),t.setLineDash([]);break}case"dotted":{t.strokeStyle=l,t.setLineDash([e,e]),t.beginPath(),t.roundRect(e/2,e/2,a-e,r-e,_),t.stroke(),t.setLineDash([]);break}default:t.strokeStyle=l,t.beginPath(),t.roundRect(e/2,e/2,a-e,r-e,_),t.stroke()}}})();
